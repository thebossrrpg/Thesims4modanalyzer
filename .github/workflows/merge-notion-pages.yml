name: Merge Notion pages into snapshot

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update-notion-pages]

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout analyzer repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Download analyzer_notionsync artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          repo: thebossrrpg/notion-ticktick-automation
          workflow: sync-priority.yml          # nome EXATO do arquivo do workflow
          branch: feat/analyzer-notion-export  # branch onde o artifact Ã© gerado
          name: analyzer_notionsync
          path: .
          search_artifacts: true
          if_no_artifact_found: fail

      - name: List downloaded files
        run: ls -R


      - name: Install deps
        run: |
          npm install

      - name: Merge Notion pages into snapshot
        run: |
          npx ts-node scripts/mergeNotionPagesIntoSnapshot.ts snapshot.json analyzer_notionsync.json


      - name: Commit and push updated snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add snapshot.json
          git commit -m "chore: merge Notion pages into snapshot" || exit 0
          git push
