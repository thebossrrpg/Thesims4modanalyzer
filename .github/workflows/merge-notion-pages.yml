name: Merge Notion pages into snapshot

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update-notion-pages]

jobs:
  merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout analyzer repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Download analyzer_notionsync artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo: thebossrpg/notion-ticktick-automation
          name: analyzer_notionsync
          path: .
          search_artifacts: true


      - name: Merge Notion pages into snapshot
        run: |
          node scripts/mergeNotionPagesIntoSnapshot.js snapshot.json analyzer_notionsync.json

      - name: Commit and push updated snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add snapshot.json
          git commit -m "chore: merge Notion pages into snapshot" || exit 0
          git push
